version: 2.1

jobs: 

  lint: 
    docker: 
      - images: circleci/python:3.6.7-stretch
    steps: 
      - checkout
      - restore_cache:
          keys:
          - v1-dependencies-{{ checksum "requirements.txt" }}
      - run:
          name: install dependencies
          command: |
            python3 -m venv venv
            . venv/bin/activate
            pip install -r requirements.txt
      - run: 
          name: install hadolint 
          command: | 
            curl -sSL https://github.com/hadolint/hadolint/releases/download/v2.7.0/hadolint-Linux-x86_64 > /usr/bin/hadolint
            chmod +x /usr/bin/hadolint 
      - run: 
          name: linting dockerfile
          command: |
            . venv/bin/activate
            make lint
      - save_cache:
          paths:
            - ./venv
          key: v1-dependencies-{{ checksum "requirements.txt" }}


  buid-docker: 
    environment: 
      IMAGE_NAME: laclac0901/hello                     
    docker:
      - image: circleci/buildpack-deps:stretch
    working_directory: ~/devops-capstone
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build docker image
          command: |
            docker build -t $IMAGE_NAME:latest .
            echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            docker push $IMAGE_NAME:latest


workflows:
  default:
    jobs:
      - lint
      - build-docker